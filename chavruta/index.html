<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ChavrutaGPT ¬∑ LuminaNexus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Shared site styles -->
    <link rel="stylesheet" href="../assets/luminanexus.css" />

    <style>
      body {
        margin: 0;
        padding: 0;
        background: #050716;
        color: #f7f7ff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      .page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .inner {
        max-width: 1080px;
        margin: 0 auto;
        padding: 0 1.5rem;
      }

      /* Header / Nav */
      header {
        position: sticky;
        top: 0;
        z-index: 20;
        background: radial-gradient(circle at top, #151937, #050716);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .header-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.9rem 1.5rem;
      }

      .logo {
        font-size: 0.8rem;
        letter-spacing: 0.26em;
        text-transform: uppercase;
        opacity: 0.92;
      }

      nav {
        display: flex;
        gap: 1.4rem;
        font-size: 0.78rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
      }

      nav a {
        opacity: 0.7;
        position: relative;
      }

      nav a:hover,
      nav a.is-active {
        opacity: 1;
      }

      nav a.is-active::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: -0.4rem;
        height: 2px;
        border-radius: 999px;
        background: linear-gradient(90deg, #ffb347, #ff5f6d);
      }

      @media (max-width: 720px) {
        .header-inner {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.6rem;
        }

        nav {
          flex-wrap: wrap;
          gap: 0.9rem;
        }
      }

      /* Main */
      main {
        padding: 3rem 0 3.5rem;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 2.2fr) minmax(0, 2.8fr);
        gap: 2.4rem;
        align-items: flex-start;
      }

      @media (max-width: 960px) {
        .layout {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .hero-kicker {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.24em;
        color: #ffcfa2;
        margin-bottom: 0.75rem;
      }

      .hero-title {
        font-size: 2rem;
        line-height: 1.2;
        margin-bottom: 0.5rem;
      }

      .hero-title span {
        background: linear-gradient(120deg, #ffd082, #ff7b9c);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .hero-text {
        font-size: 0.95rem;
        line-height: 1.7;
        color: #ceceff;
        margin-bottom: 1.2rem;
      }

      .hero-note {
        font-size: 0.83rem;
        color: #a9a8ff;
        margin-bottom: 1.4rem;
      }

      .prompt-list {
        font-size: 0.85rem;
        color: #d6d5ff;
        margin: 0;
        padding-left: 1.1rem;
      }

      .prompt-list li {
        margin-bottom: 0.4rem;
      }

      .notice {
        font-size: 0.78rem;
        color: #b7b6ff;
        margin-top: 1.4rem;
      }

      .notice strong {
        color: #ffdba5;
      }

      /* Chat panel */
      .chat-panel {
        border-radius: 1.3rem;
        background: radial-gradient(circle at top left, #181b3a, #050716);
        border: 1px solid rgba(255, 255, 255, 0.06);
        box-shadow: 0 18px 46px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        height: 520px;
      }

      @media (max-width: 640px) {
        .chat-panel {
          height: 480px;
        }
      }

      .chat-header {
        padding: 0.9rem 1.2rem 0.7rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 0.75rem;
      }

      .chat-title {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
      }

      .chat-subtitle {
        font-size: 0.78rem;
        color: #bdbdff;
      }

      .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 0.9rem 1.2rem 0.9rem;
        font-size: 0.9rem;
      }

      .chat-body-inner {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }

      .message {
        max-width: 92%;
        padding: 0.55rem 0.75rem;
        border-radius: 0.9rem;
        line-height: 1.5;
        word-wrap: break-word;
        white-space: pre-wrap;
      }

      .message.user {
        align-self: flex-end;
        background: linear-gradient(135deg, #ffb347, #ff5f6d);
        color: #050716;
        border-bottom-right-radius: 0.2rem;
      }

      .message.chavruta {
        align-self: flex-start;
        background: rgba(12, 14, 36, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-bottom-left-radius: 0.2rem;
        color: #f2f2ff;
      }

      .message.system-note {
        align-self: center;
        background: transparent;
        color: #a9a8ff;
        font-size: 0.8rem;
        text-align: center;
      }

      .chat-footer {
        padding: 0.7rem 0.9rem 0.9rem;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
      }

      .input-row {
        display: flex;
        gap: 0.45rem;
        align-items: center;
      }

      .input-row input {
        flex: 1;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(4, 7, 30, 0.9);
        color: #f5f5ff;
        padding: 0.55rem 0.9rem;
        font-size: 0.86rem;
      }

      .input-row input:focus {
        outline: none;
        border-color: #ffb347;
      }

      .icon-button,
      .send-button {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.26);
        background: transparent;
        color: #f5f5ff;
        font-size: 0.9rem;
        width: 2.2rem;
        height: 2.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .icon-button[disabled] {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .send-button {
        width: auto;
        padding: 0.55rem 1.1rem;
        background: linear-gradient(135deg, #ffb347, #ff5f6d);
        border: none;
        color: #050716;
        font-size: 0.8rem;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        font-weight: 600;
        box-shadow: 0 8px 22px rgba(255, 100, 90, 0.4);
      }

      .send-button:disabled {
        opacity: 0.6;
        cursor: wait;
        box-shadow: none;
      }

      .status-line {
        margin-top: 0.45rem;
        font-size: 0.76rem;
        color: #b7b6ff;
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .status-error {
        color: #ff9ea5;
      }

      /* Footer */
      footer {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1.2rem 0 1.6rem;
        font-size: 0.75rem;
        color: #a6a6cf;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <!-- Header -->
      <header>
        <div class="inner header-inner">
          <div class="logo">
            LUMINANEXUS ¬∑ A NEXUS OF TORAH, LIGHT, AND LEARNING
          </div>
          <nav>
            <a href="../index.html">Home</a>
            <a href="index.html" class="is-active">ChavrutaGPT</a>
            <a href="../library/index.html">Celestial Library</a>
            <a href="../sefaria-library.html">Sefaria</a>
            <a href="../flipbooks.html">Flip&nbsp;Books</a>
          </nav>
        </div>
      </header>

      <!-- Main -->
      <main class="inner">
        <div class="layout">
          <!-- Left: explanation and sample prompts -->
          <section>
            <div class="hero-kicker">ChavrutaGPT</div>
            <h1 class="hero-title">
              Study with a gentle <span>AI chavruta</span>.
            </h1>
            <p class="hero-text">
              ChavrutaGPT is a calm, non-polemical Torah study partner. Ask
              about Tanakh, Midrash, Talmud, halakhah, or the 231 Gates, and
              learn together at your own pace.
            </p>
            <p class="hero-note">
              He is not a rabbi or posek, and does not give binding halakhic
              rulings. He is here to explore, clarify, and wonder with you.
            </p>

            <h2 style="font-size: 0.95rem; margin-bottom: 0.4rem;">
              Try asking:
            </h2>
            <ul class="prompt-list">
              <li>‚ÄúShalom, Chavruta. Help me return to learning after a long time away.‚Äù</li>
              <li>‚ÄúLet‚Äôs study Gate Aleph‚ÄìBet ‚Äî the ‚ÄòFirst Shelter‚Äô ‚Äî with sources.‚Äù</li>
              <li>‚ÄúShow me Sefaria sources about Shabbat as a bride.‚Äù</li>
              <li>‚ÄúI‚Äôm having a hard day. Can we learn something comforting?‚Äù</li>
            </ul>

            <p class="notice">
              <strong>Voice:</strong> You can speak to Chavruta with the üéôÔ∏è
              button (in supported browsers), and toggle his spoken voice with
              the üîà / üîá button.
            </p>
          </section>

          <!-- Right: chat panel -->
          <section id="chavruta-chat">
            <div class="chat-panel">
              <div class="chat-header">
                <div class="chat-title">ChavrutaGPT</div>
                <div class="chat-subtitle">
                  A patient Torah study partner ¬∑ LuminaNexus.org
                </div>
              </div>

              <div class="chat-body">
                <div id="chavruta-messages" class="chat-body-inner">
                  <div class="message system-note">
                    üëã Shalom, I am ChavrutaGPT. I am happy to learn with you.
                    Ask about a verse, a mitzvah, a Gate, or anything on your
                    heart.
                  </div>
                </div>
              </div>

              <div class="chat-footer">
                <div class="input-row">
                  <input
                    id="chavruta-input"
                    type="text"
                    autocomplete="off"
                    placeholder="Ask Chavruta‚Ä¶ or tap üéôÔ∏è to speak"
                  />
                  <button
                    id="chavruta-mic"
                    type="button"
                    class="icon-button"
                    title="Speak to Chavruta"
                  >
                    üéôÔ∏è
                  </button>
                  <button
                    id="chavruta-voice-toggle"
                    type="button"
                    class="icon-button"
                    title="Toggle Chavruta's voice"
                  >
                    üîà
                  </button>
                  <button
                    id="chavruta-send"
                    type="button"
                    class="send-button"
                  >
                    Send
                  </button>
                </div>
                <div class="status-line">
                  <span id="status-text">Ready.</span>
                  <span id="status-error" class="status-error"></span>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>

      <!-- Footer -->
      <footer>
        <div class="inner">
          LuminaNexus.org ‚Äî ChavrutaGPT, the Celestial Library of 231 Gates,
          free flip books, and the Sefaria online study library.
        </div>
      </footer>
    </div>

    <script>
      // Basic chat wiring
      const messagesEl = document.getElementById("chavruta-messages");
      const inputEl = document.getElementById("chavruta-input");
      const sendBtn = document.getElementById("chavruta-send");
      const statusText = document.getElementById("status-text");
      const statusError = document.getElementById("status-error");

      const micButton = document.getElementById("chavruta-mic");
      const voiceToggleButton = document.getElementById("chavruta-voice-toggle");

      let isSending = false;
      let conversation = []; // {role, content} messages sent to the server
      let recognition = null;
      let isListening = false;
      let voiceEnabled = true;

      function addMessage(role, text) {
        const div = document.createElement("div");
        if (role === "user") {
          div.className = "message user";
        } else if (role === "assistant") {
          div.className = "message chavruta";
        } else {
          div.className = "message system-note";
        }
        div.textContent = text;
        messagesEl.appendChild(div);
        messagesEl.parentElement.scrollTop = messagesEl.parentElement.scrollHeight;
      }

      async function sendMessage() {
        const text = inputEl.value.trim();
        if (!text || isSending) return;

        statusError.textContent = "";
        isSending = true;
        inputEl.value = "";
        sendBtn.disabled = true;
        statusText.textContent = "Asking Chavruta‚Ä¶";

        // Show user message
        addMessage("user", text);
        conversation.push({ role: "user", content: text });

        try {
          const response = await fetch("/.netlify/functions/chavruta-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages: conversation }),
          });

          const textBody = await response.text();
          if (!response.ok) {
            console.error("Chavruta function error:", response.status, textBody);
            statusError.textContent =
              "There was an error talking to ChavrutaGPT.";
            statusText.textContent = "Error.";
            return;
          }

          let data;
          try {
            data = JSON.parse(textBody);
          } catch (err) {
            console.error("Failed to parse JSON:", err, textBody);
            statusError.textContent = "Bad response from server.";
            statusText.textContent = "Error.";
            return;
          }

          const message =
            data &&
            data.message &&
            data.message.content
              ? data.message.content
              : "[No reply received]";

          conversation.push({ role: "assistant", content: message });
          addMessage("assistant", message);
          speakChavruta(message);
          statusText.textContent = "Ready.";
        } catch (err) {
          console.error("Network error:", err);
          statusError.textContent = "Network error reaching Chavruta.";
          statusText.textContent = "Error.";
        } finally {
          isSending = false;
          sendBtn.disabled = false;
        }
      }

      sendBtn.addEventListener("click", sendMessage);

      inputEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      });

      // --- Voice Recognition (speech to text) ---
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = "en-US"; // adjust later if desired
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.addEventListener("result", (event) => {
          const transcript = event.results[0][0].transcript;
          inputEl.value = transcript;
        });

        recognition.addEventListener("start", () => {
          isListening = true;
          micButton.textContent = "üõë";
          statusText.textContent = "Listening‚Ä¶";
        });

        recognition.addEventListener("end", () => {
          isListening = false;
          micButton.textContent = "üéôÔ∏è";
          statusText.textContent = "Ready.";
        });

        recognition.addEventListener("error", (event) => {
          console.error("Speech recognition error:", event.error);
          isListening = false;
          micButton.textContent = "üéôÔ∏è";
          statusError.textContent = "Speech recognition error.";
          statusText.textContent = "Ready.";
        });

        micButton.addEventListener("click", () => {
          if (!recognition) return;
          if (isListening) {
            recognition.stop();
          } else {
            statusError.textContent = "";
            recognition.start();
          }
        });
      } else {
        micButton.disabled = true;
        micButton.title = "Speech recognition not supported in this browser";
      }

      // --- Text-to-Speech (Chavruta speaks back) ---
      function speakChavruta(text) {
        if (!voiceEnabled) return;
        if (!("speechSynthesis" in window)) {
          console.warn("Text-to-speech not supported in this browser.");
          return;
        }
        if (!text) return;

        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        // Optional: choose voice by language
        // const voices = window.speechSynthesis.getVoices();
        // const match = voices.find((v) => v.lang.startsWith("en"));
        // if (match) utterance.voice = match;

        window.speechSynthesis.speak(utterance);
      }

      voiceToggleButton.addEventListener("click", () => {
        voiceEnabled = !voiceEnabled;
        voiceToggleButton.textContent = voiceEnabled ? "üîà" : "üîá";
        statusText.textContent = voiceEnabled
          ? "Voice enabled."
          : "Voice muted.";
      });
    </script>
  </body>
</html>
