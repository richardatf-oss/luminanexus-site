<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ChavrutaGPT ¬∑ LuminaNexus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Shared site styles -->
    <link rel="stylesheet" href="../assets/css/luminanexus.css" />

    <!-- Page-specific tweaks: keep chat prominent, especially on mobile -->
    <style>
      body.chavruta-page #chavruta-chat {
        scroll-margin-top: 90px; /* keep anchor below sticky header */
      }

      @media (max-width: 768px) {
        body.chavruta-page .page {
          padding-top: 1.25rem;
        }

        body.chavruta-page .chavruta-layout {
          margin-top: 0.5rem;
        }
      }
    </style>
  </head>

  <body class="chavruta-page">
    <!-- Site header / nav -->
    <header class="site-header">
      <div class="inner header-inner">
        <div class="brand">
          <a href="/" class="brand-mark">LUMINANEXUS</a>
          <span class="brand-tagline">A nexus of Torah, light, and learning</span>
        </div>
        <nav class="main-nav">
          <a href="/">Home</a>
          <a href="/chavruta/" class="is-active">ChavrutaGPT</a>
          <a href="/library/">Celestial Library</a>
          <a href="/sefaria-library.html">Sefaria</a>
          <a href="/flipbooks.html">Flip Books</a>
        </nav>
      </div>
    </header>

    <main class="page">
      <div class="inner">
        <!-- Compact heading above chat -->
        <section style="margin-bottom: 0.75rem;">
          <div class="hero-eyebrow">LEARNING TOGETHER</div>
          <h1 style="margin: 0; font-size: 1.35rem; color: #f9fafb;">
            ChavrutaGPT
            <span style="font-size: 0.9rem; opacity: 0.85;">
              ¬∑ your always-awake study partner
            </span>
          </h1>
        </section>

        <!-- MAIN CHAT AREA ‚Äì high on the page -->
        <section class="chavruta-layout" id="chavruta-chat">
          <!-- Left: live chat -->
          <div class="ln-chat-shell" aria-label="ChavrutaGPT chat">
            <div style="display: flex; justify-content: space-between; gap: 0.75rem;">
              <div>
                <h2 style="margin: 0 0 0.25rem; font-size: 1rem; color: #f9fafb;">
                  Live Chavruta
                </h2>
                <p style="margin: 0; font-size: 0.8rem; opacity: 0.85;">
                  Ask a question, share a thought, or paste a line from Sefaria.
                </p>
              </div>
              <div
                style="
                  font-size: 0.75rem;
                  text-align: right;
                  opacity: 0.8;
                  max-width: 180px;
                "
              >
                Guided, gentle, non-polemical.
              </div>
            </div>

            <!-- Chat window -->
            <div class="ln-chat-window" id="chat-window">
              <!-- Messages will be appended here -->
            </div>

            <!-- Input area -->
            <div class="ln-input-row" style="margin-top: 0.75rem; flex-wrap: wrap;">
              <textarea
                id="user-input"
                class="ln-input-textarea"
                placeholder="Ask a question, share a thought, or paste a line from Sefaria‚Ä¶"
              ></textarea>
              <button id="send-btn" class="ln-send-btn">Send</button>
            </div>

            <!-- Controls row: mic + voice -->
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                justify-content: space-between;
                gap: 0.5rem;
                margin-top: 0.35rem;
                font-size: 0.78rem;
                color: #e5e7eb;
              "
            >
              <button
                id="mic-btn"
                type="button"
                style="
                  border-radius: 999px;
                  border: 1px solid rgba(248, 250, 252, 0.55);
                  background: transparent;
                  color: #e5e7eb;
                  padding: 0.25rem 0.7rem;
                  font-size: 0.78rem;
                  cursor: pointer;
                "
              >
                üéôÔ∏è Speak
              </button>

              <div class="ln-voice-toggle">
                <span>Voice for Chavruta‚Äôs replies:</span>
                <select
                  id="voice-select"
                  style="
                    background: rgba(15, 23, 42, 0.95);
                    border-radius: 999px;
                    border: 1px solid rgba(148, 163, 184, 0.9);
                    color: #f9fafb;
                    padding: 0.2rem 0.7rem;
                    font-size: 0.75rem;
                  "
                >
                  <option value="off">No voice</option>
                  <option value="female" selected>Female voice</option>
                  <option value="male">Male voice</option>
                </select>
              </div>
            </div>

            <div
              id="chat-status"
              style="margin-top: 0.35rem; font-size: 0.75rem; opacity: 0.8;"
            >
              Ready.
            </div>

            <div
              style="
                margin-top: 0.5rem;
                font-size: 0.7rem;
                opacity: 0.7;
                text-align: right;
              "
            >
              ChavrutaGPT is powered by the OpenAI API via a secure Netlify
              Function.
            </div>
          </div>

          <!-- Right: how-to and prompts -->
          <aside class="chavruta-right-card">
            <h2>How to use ChavrutaGPT</h2>
            <p>
              This is your dedicated space for learning with an AI chavruta.
              Bring texts from Sefaria, questions from the 231 Gates, or anything
              that‚Äôs on your heart.
            </p>
            <ul
              style="
                padding-left: 1.1rem;
                margin: 0.5rem 0 0.75rem;
                font-size: 0.8rem;
              "
            >
              <li>Paste a verse or passage you‚Äôre learning.</li>
              <li>Ask for background, commentary, or connections.</li>
              <li>Ask for gentle questions to deepen your own thinking.</li>
              <li>
                Use the microphone button if speaking is easier than typing
                (desktop &amp; some mobile browsers).
              </li>
              <li>
                Choose a male or female reading voice ‚Äî hashtags in text are
                ignored so Chavruta doesn‚Äôt say ‚Äúhash tag, hash tag‚Ä¶‚Äù.
              </li>
            </ul>
            <p style="font-size: 0.8rem; margin-top: 0.4rem;">
              Remember: this chavruta is here to support your learning, not to
              replace real teachers or community.
            </p>
          </aside>
        </section>

        <!-- Sefaria inline view below chat -->
        <section class="sefaria-embed">
          <div class="sefaria-embed-header">
            <div>
              <strong>Sefaria Inline View</strong> ¬∑ Tanakh &amp; classic sources
            </div>
            <div>
              If this panel doesn‚Äôt load, use the button above to open Sefaria in
              a new tab.
            </div>
          </div>
          <iframe
            class="sefaria-embed-iframe"
            src="https://www.sefaria.org/texts"
            title="Sefaria Online Study Library"
            loading="lazy"
          ></iframe>
        </section>
      </div>
    </main>

    <footer class="site-footer">
      <div class="inner">
        <p class="footer-line">
          LuminaNexus.org ‚Äî ChavrutaGPT, the Celestial Library of 231 Gates,
          Sefaria gateway, and free flip-books of Torah.
        </p>
      </div>
    </footer>

    <!-- CHAT / VOICE SCRIPT -->
    <script>
      const chatWindow = document.getElementById("chat-window");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");
      const micBtn = document.getElementById("mic-btn");
      const voiceSelect = document.getElementById("voice-select");
      const statusEl = document.getElementById("chat-status");

      const history = []; // simple in-browser conversation history

      function appendMessage(role, text) {
        const wrapper = document.createElement("div");
        wrapper.className =
          role === "user" ? "ln-chat-message-user" : "ln-chat-message-assistant";

        const bubble = document.createElement("div");
        bubble.className = "ln-chat-bubble";
        bubble.textContent = text;

        wrapper.appendChild(bubble);
        chatWindow.appendChild(wrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      // Initial greeting
      appendMessage(
        "assistant",
        "Shalom, havruta. What would you like to learn or explore today?"
      );

      // Helper to extract a clean reply string from any shape of data
      function extractReplyText(data) {
        if (!data) return "";

        // If backend just returns a string
        if (typeof data === "string") return data;

        // Simple reply string
        if (typeof data.reply === "string") return data.reply;

        // reply as object with .content
        if (data.reply && typeof data.reply.content === "string") {
          return data.reply.content;
        }

        // responses API style: { message: { role, content, ... } }
        if (data.message && typeof data.message.content === "string") {
          return data.message.content;
        }

        // legacy ChatCompletion: choices[0].message.content
        if (
          Array.isArray(data.choices) &&
          data.choices[0] &&
          data.choices[0].message &&
          typeof data.choices[0].message.content === "string"
        ) {
          return data.choices[0].message.content;
        }

        if (typeof data.message === "string") return data.message;

        // Fallback: stringify so we at least see something
        try {
          return JSON.stringify(data);
        } catch {
          return "";
        }
      }

      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage("user", text);
        history.push({ role: "user", content: text });
        userInput.value = "";
        userInput.focus();
        sendBtn.disabled = true;
        sendBtn.textContent = "‚Ä¶";
        statusEl.textContent = "Talking to ChavrutaGPT‚Ä¶";

        try {
          const response = await fetch("/.netlify/functions/chavruta-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              history: history
            })
          });

          if (!response.ok) {
            throw new Error("Network error: " + response.status);
          }

          const data = await response.json();
          const replyText =
            extractReplyText(data) ||
            "I received a response from the server, but I‚Äôm not sure how to read it.";

          appendMessage("assistant", replyText);
          history.push({ role: "assistant", content: replyText });
          statusEl.textContent = "Ready.";
          speakReply(replyText);
        } catch (err) {
          console.error(err);
          appendMessage(
            "assistant",
            "I‚Äôm having trouble reaching the server right now."
          );
          statusEl.textContent = "Error reaching the server.";
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = "Send";
        }
      }

      sendBtn.addEventListener("click", sendMessage);

      userInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      });

      // Ensure chat is visible when coming from #chavruta-chat
      document.addEventListener("DOMContentLoaded", () => {
        if (window.location.hash === "#chavruta-chat") {
          const el = document.getElementById("chavruta-chat");
          if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }
      });

      // === Speech recognition (microphone) ================================
      let recognition = null;
      let isListening = false;

      function setupRecognition() {
        const SR =
          window.SpeechRecognition || window.webkitSpeechRecognition || null;
        if (!SR) return null;

        const rec = new SR();
        rec.lang = "en-US";
        rec.interimResults = false;
        rec.maxAlternatives = 1;

        rec.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          userInput.value = userInput.value
            ? userInput.value + " " + transcript
            : transcript;
          userInput.focus();
        };

        rec.onerror = () => {
          isListening = false;
          micBtn.textContent = "üéôÔ∏è Speak";
        };

        rec.onend = () => {
          isListening = false;
          micBtn.textContent = "üéôÔ∏è Speak";
        };

        return rec;
      }

      if ("SpeechRecognition" in window || "webkitSpeechRecognition" in window) {
        recognition = setupRecognition();
      } else {
        // Hide mic button if not supported
        micBtn.style.display = "none";
      }

      function toggleMic() {
        if (!recognition) return;
        if (isListening) {
          recognition.stop();
          return;
        }
        try {
          isListening = true;
          micBtn.textContent = "üõë Stop";
          recognition.start();
        } catch (e) {
          isListening = false;
          micBtn.textContent = "üéôÔ∏è Speak";
        }
      }

      micBtn.addEventListener("click", toggleMic);

      // === Text-to-speech (Chavruta's voice) ============================
      let availableVoices = [];

      function loadVoices() {
        if (!("speechSynthesis" in window)) return;
        availableVoices = window.speechSynthesis.getVoices();
      }

      if ("speechSynthesis" in window) {
        loadVoices();
        window.speechSynthesis.onvoiceschanged = loadVoices;
      }

      function pickVoice(preferred) {
        if (!availableVoices || availableVoices.length === 0) return null;
        const langMatches = availableVoices.filter(
          (v) => v.lang && v.lang.toLowerCase().startsWith("en")
        );

        if (preferred === "female") {
          const femaleCandidates = langMatches.filter((v) =>
            /female|samantha|victoria|Google US English/i.test(v.name)
          );
          if (femaleCandidates.length) return femaleCandidates[0];
        }

        if (preferred === "male") {
          const maleCandidates = langMatches.filter((v) =>
            /male|alex|daniel|fred|Google UK English Male/i.test(v.name)
          );
          if (maleCandidates.length) return maleCandidates[0];
        }

        return langMatches[0] || availableVoices[0];
      }

      function cleanForSpeech(text) {
        return text
          .replace(/#[^\s]+/g, "") // remove hashtag words
          .replace(/hash\s*tag/gi, "")
          .replace(/\s{2,}/g, " ")
          .trim();
      }

      function speakReply(text) {
        if (!("speechSynthesis" in window)) return;

        const mode = voiceSelect.value;
        if (!mode || mode === "off") return;

        const cleaned = cleanForSpeech(text);
        if (!cleaned) return;

        const utterance = new SpeechSynthesisUtterance(cleaned);
        utterance.volume = 1.0;
        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        const preferred = mode === "female" ? "female" : "male";
        const voice = pickVoice(preferred);
        if (voice) utterance.voice = voice;

        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      }
    </script>
  </body>
</html>
